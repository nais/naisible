- name: Create logs group
  group:
    name: logs
    gid: 1065
    state: present

- name: Create fluent user
  user:
    name: fluent
    uid: 1065
    group: logs
    home: /
    createhome: no
    shell: /sbin/nologin
    state: present

- name: Ensure journal logdir exist
  file:
    state: directory
    path: "/var/log/journal"

- name: Install journal config
  copy:
    src: "{{ role_path }}/files/journald.conf"
    dest: "/etc/systemd/journald.conf"
  notify:
    - Restart journald

- name: Ensure container dir exist
  file:
    state: directory
    path: "/var/lib/docker/containers"
    owner: root
    group: root
    mode: 0711

- name: Remove set-log-dir-acl systemd service
  file:
    path: /etc/systemd/system/set-log-dir-acl.service
    state: absent

- name: Remove set-container-dir-acl systemd service
  file:
    path: /etc/systemd/system/set-container-dir-acl.service
    state: absent

- name: Remove set-container-dir-acl systemd timer
  file:
    path: /etc/systemd/system/set-container-dir-acl.timer
    state: absent

- name: Disable set-log-dir-acl
  systemd:
    name: set-log-dir-acl.service
    state: stopped
    enabled: no
    daemon_reload: yes
  ignore_errors: yes

- name: Disable set-container-dir-acl
  systemd:
    name: set-container-dir-acl.timer
    state: stopped
    enabled: no
    daemon_reload: yes
  ignore_errors: yes

  - name: Disable set-container-dir-acl service
  systemd:
    name: set-container-dir-acl.service
    state: stopped
    enabled: no
    daemon_reload: yes
  ignore_errors: yes
